# 容器安全防护
## linux内核安全机制
这是docker当中的基础安全，通常使用内核的命名空间，控制组等对资源进行隔离和限制。
### 命名空间
### 控制组
### 内核功能限制（capabilities）机制
通常 Linux 系统上众多的服务进程以 root 用户权限运行，比如 SSH、Cron、Syslog、硬件管理工具、网络配 置工具等，一旦服务被攻击者攻破，攻击者就有系统最高权限进行破坏。Linux 内核功能提供了更细粒度的权限 控制，例如挂载、访问文件系统，以及内核模块加载等。

容器服务可利用 Linux 内核功能的机制，在多数情况下避免使用真正的主机 root 用户权限。因此容器可以运 行在一个内核功能集合的约束下，比如在容器创建的时候，可以拒绝所有的挂载(mount)文件系统、访问原始 套接字、创建新设备节点、以及更改文件所有者 / 属性等文件系统操作。这样，即使容器遭到攻击者入侵，攻击 者也是很难在容器内部对宿主机做恶意操作。

默认情况下，docker采用白名单方式实现功能限制。不过运行 Docker 容器时有一个风险:容器采用默认内核功能和挂载可能会导致容器之间的隔离问题，此外，攻击者通过主机系统漏洞对容器产生威胁。因此 Docker 允许通过使用非默认配置文件添加和删除内核功能，来 增加其安全性。对于用户，应该明确其所需的具体功能，删除不必要的内核功能。


### 其他内核安全机制
内核功能是现代 Linux 内核提供的众多安全特性之一，除此之外，还可以利用其它常用的安全机制来加固和
防护 Docker 容器，比如 TOMOYO，AppArmor，SELinux[53]，Grsec[54] 等。

比如使用 Grsec 和 PAX 运行内核可在编译和运行时，基于地址随机化等技术增加安全检查，这样就避免了
许多漏洞利用。由于这些安全特性属于宿主机系统范畴，独立于容器，因此不需要对容器进行特殊的配置。
另外，如果使用的发行版操作系统带有 Docker 容器的安全模板，则可以直接使用。例如，Docker 官方团队 发布了一个可与 AppArmor 配合使用的模板，Red Hat 也提供了适用于 Docker 的 SELinux 策略。这些模板提供 了一个额外的安全网，用户可以使用特定的访问控制机制来定义自己的策略。

#### SELinux安全加固
强制访问控制(Mandatory Access Control，MAC)，它是指计算机系统根据使用系统机构事先确
定的安全策略，对用户的访问权限进行强制性的控制，也就是说系统独立于用户行为强制执行访问控制。在这种访问控制体系的限制下，进程只能访问那些在它的任务中所需的文件。对于目前可用的 Linux 安全模块来说， SELinux 功能最全面，而且测试最充分，它是基于对 MAC 20 年的研究基础之上建立的。

#### AppArmor安全加固
AppArmor 也是一种 MAC 控制机制，其主要作用是设置某个可执行程序的访问控制权限，可以限制程序读 /写某个目录/文件，打开/读/写网络端口等。Docker 服务在启动过程中会判断当前内核是否支持 AppArmor，若支持，就创建默认的 AppArmor 配置文件 /etc/apparmor.d/docker，并应用这个配置文件。启动容器时，在初始化过程中 Docker 会使用相应的 AppArmor 配置作用于容器。也可以使用 –security-opt 选项来指定作用于容器的 AppArmor 配置文件。

### 基准配制文档
[文档地址](https://www.cisecurity.org/cis-benchmarks/)
Docker 公司与美国互联网安全中心(Center for Internet Security，CIS)合作，发布了一份详尽的基准配置 文档 ，该基准文档从容器主机、Docker 守护进程、镜像配置、运行配置等方面，给出了参考的配置建议。


## 容器服务安全
容器的管理和编排服务的安全直接影响了容器控制平面的安全。docker守护进程的配置合理与否，将在一定程度上影响docker的安全性。建议在守护进程启动时进行一下配置。

### 限制容器间网络流量

认情况下，同一主机上的容器之间是允许所有通信的，即黑名单机制，可根据业务需求添加访问控制规则。 为了进一步限制容器间通信，可以采用白名单机制(给 Docker 守护进程传递命令行参数 --icc = false )，即默认 容器间的通信是禁止的，只有显示添加规则才可以访问。此外，也可将容器加入自定义的网络，也可以限制与其 它网络的容器间通信。

### 设置集中和远程日志管理

容器的生命周期很短，且业务变化很快，为了完成该场景下的安全分析和取证，需要将日志存放在远程集中
的平台中，可以通过 docker --log-driver=syslog --log-opt syslog-address=tcp://192.xxx.xxx.xxx 进行设置。

### 允许 Docker 更改 Iptables 规则

允许docker daemon进程自动更新iptables配置。

### 不使用AUFS作为存储驱动程序

默认使用Device Mapper作为存储驱动。

### 使用cgroups

### 遵循在docker daemon级别设置ulimit

ulimit 是一种 Linux 系统的内建功能，它具有一套参数集，用于为由它生成的 Shell 进程及其子进程的资源使 用设置限制。其支持限制的资源包括:所创建的内核文件的大小、进程数据块的大小、Shell 进程创建文件的大小、 内存锁住的大小、常驻内存集的大小、打开文件描述符的数量、分配堆栈的最大值、CPU 时间、单个用户的最大 线程数、Shell 进程所能使用的最大虚拟内存。同时，它也支持硬资源和软资源的限制。

设置系统资源控制可以防止资源耗尽带来的问题，比如 Fork 炸弹，有时候合法的用户和进程也可能造成过 度的使用系统资源，导致系统资源耗尽。因此在 Docker 服务需要设置默认的 ulimit 值，实现相应的资源控制。

### 使用可信仓库


## 主机安全
### 主机基本安全加固建议
容器与宿主机共享操作系统内核，因此宿主机的配置对容器运行的安全有着重要的影响，比如宿主机中安装 有漏洞的软件可能会导致任意代码执行风险，端口无限制开放可能会导致任意用户访问风险，防火墙未正确配置 会降低主机的安全性，sudo的访问权限没有按照密钥的认证方式登录可能会导致暴力破解宿主机。

从安全性考虑，容器主机应遵循如最小安装化，不应当安装额外的服务和软件以免增大安全风险;配置交互 用户登陆超时时间;关闭不必要的数据包转发功能;禁止 ICMP 重定向;配置可远程访问地址范围;删除或锁定 与设备运行、维护等工作无关的账号、重要文件和目录的权限设置;关闭不必要的进程和服务等安全加固原则。

### 容器相关安全加固建议

- 为容器的存储分配单独的分区
- 宿主机安全加固
- 更新docker到最新版本
- 守护进程的权限控制
- 对docker daemon 进行审计
- 对docker相关的文件和目录进行审计

