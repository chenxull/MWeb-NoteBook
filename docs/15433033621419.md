# SElinux

Linux传统的文件权限与帐号关系：自主式存取控制, DAC。系统的帐号主要分为系统管理员 （root） 与一般用户，而这两种 身份能否使用系统上面的文件资源则与 rwx 的权限设置有关。 不过你要注意的是，各种权限 设置对 root 是无效的。因此，当某个程序想要对文件进行存取时， 系统就会根据该程序的拥 有者/群组，并比对文件的权限，若通过权限检查，就可以存取该文件了。

这种存取文件系统的方式被称为“自主式存取控制 （Discretionary Access Control, DAC）”， 基本上，就是依据程序的拥有者与文件资源的 rwx 权限来决定有无存取的能力。 不过这种 DAC 的存取控制有几个困扰，那就是：

- root 具有最高的权限：如果不小心某支程序被有心人士取得， 且该程序属于 root 的权 限，那么这支程序就可以在系统上进行任何资源的存取！
- 使用者可以取得程序来变更文件资源的存取权限：如果你不小心将某个目录的权限设置 为 777 ，由于对任何人的权限会变成 rwx ，因此该目录就会被任何人所任意存取！

SELinux 导入了委任式存取控制 （Mandatory Access Control, MAC） 的方法。委任式存取控制 （MAC） 有趣啦！他可以针对特定的程序与特定的文件资源来进行权限的控 管！ 也就是说，即使你是 root ，那么在使用不同的程序时，你所能取得的权限并不一定是 root ， 而得要看当时该程序的设置而定。如此一来，我们针对控制的“主体”变成了“程序”而不 是使用者喔！ 此外，这个主体程序也不能任意使用系统文件资源，因为每个文件资源也有针 对该主体程序设置可取用的权限！ 如此一来，控制项目就细的多了！但整个系统程序那么 多、文件那么多，一项一项控制可就没完没了！ 所以 SELinux 也提供一些默认的政策 （Policy） ，并在该政策内提供多个规则 （rule） ，让你可以选择是否启用该控制规则！

## SELinux运行模式

SELinux 是通过 MAC 的方式来控管程序，他控制的主体是程序， 而目标则是该程序能否读取的“文件资源”。

- 主体（Subject）： SELinux 主要想要管理的就是程序，因此你可以将“主体”和 process 划上等号；
- 目标 （Object）： 主体程序能否存取的“目标资源”一般就是文件系统。因此这个目标项 目可以等文件系统划上等号；
- 政策 （Policy）： 由于程序与文件数量庞大，因此 SELinux 会依据某些服务来制订基本 的存取安全性政策。这些政策内还会有详细的规则 （rule） 来指定不同的服务开放某些 资源的存取与否。在目前的 CentOS 7.x 里面仅有提供三个主要的政策，分别是：
    - targeted：针对网络服务限制较多，针对本机限制较少，是默认的政策；
    - minimum：由 target 修订而来，仅针对选择的程序来保护！
    - mls：完整的 SELinux 限制，限制方面较为严格。建议使用默认的 targeted 政策即 可。
- 安全性本文 （security context）： 我们刚刚谈到了主体、目标与政策面，但是主体能不 能存取目标除了政策指定之外，主体与目标的安全性本文必须一致才能够顺利存取。 这 个安全性本文 （security context） 有点类似文件系统的 rwx 啦！安全性本文的内容与设 置是非常重要的！ 如果设置错误，你的某些服务（主体程序）就无法存取文件系统（目 标资源），当然就会一直出现“权限不符”的错误讯息了！
![](https://ws2.sinaimg.cn/large/006tNbRwly1fxmnluv2rzj319k0gstiw.jpg)
由上图可知，进程最终能否顺利访问到目标还是和文件系统的RWX权限的设置有关，所以在加入SELinux后出现了权限不符的情况，需要一步步排查问题所在。

