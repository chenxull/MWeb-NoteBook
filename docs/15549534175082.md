# 一致性协议
 为了保证分布式事务处理的ACID特性,需要引入二个角色.
 
 - 协调者:统一调度所有分布式节点的执行逻辑
 - 参与者:这些被调度的节点被称为参与者.

协调者负责调度参与者的行为,并最终决定这些参与者是否要把事务正在的提交。基于这个思想衍生出了二阶段提交和三阶段提交。
 
##2PC



二阶段提交.目前绝大多数数据库都采用二阶段提交协议来完成分布式事务的处理,利用该协议可以方便的完成所有分布式事务参与者的协调,统一决定事务的提交和回滚,从而能够有效的保证分布式数据的一致性.

### 阶段一：提交事务请求
1. 事务询问：协调者向所有参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各个参与者的响应
2. 执行事务：参与者节点执行事务操作，并将undo和 redo 信息记入事务日志中
3. 参与者向协调者返回事务询问的响应：如果参与者成功执行了事务操作，就返回给协调者 yes 响应，表示事务可以执行。如果没有成功执行，返回 no 给协调者。

上述过程类似于投票表决的过程，因此这一阶段也称为“投票阶段”，即各个参与者投票标明是否要继续执行下去。
### 阶段二：执行事务提交
在这个阶段中，协调者会根据参与者的反馈来决定是否最终可以进行事务的提价操作。正常情况下，有二种可能
#### 执行事务提交

1. 发起提交请求：协调者向所有参与者节点发出 commit 请求
2. 事务提交 ：参与者在接收到 commit 请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源
3. 反馈事务提交结果:完成后，参与者向协调者发送 ack 消息
4. 完成事务：协调者收到了**所有的 ack 消息**后，完成事务


#### 中断事务
假如任何一个参与者向协调者反馈了No 响应,或者在等待超时之后.协调者就会中断事务。
1. 发送回滚请求
2. 事务回滚
3. 反馈事务回滚结果
4. 中断事务


### 优缺点
- 优点：
    - 原理简单，实现方便
- 缺点：
    - 同步阻塞，单点问题，脑裂，太过保守。
### 小结
二阶段提交将事务的处理分为了**投票**和**执行**二个阶段。是一个强一致性的算法，其核心是对**每一个事务都采用先尝试后提交的处理方式**


## 3PC  
三阶段提交是二阶段提价的改版，将其**提交事务请求的过程一分为二**。形成了CanCommit,PreCommit 和 doCommit三个阶段

### 阶段一 CanCommit 
1. 事务询问:协调者向所有参与者发送包含事务内容的CanCommit请求，询问是否可以执行事务提交操作，并开始等待各个参与者的响应
2. 各个参与者向协调者反馈事务询问的响应:参与者接收到请求之后,正常情况下,如果其自身认为可以顺利执行事务,那么反馈 yes 响应,进入预备状态.反之发送 no.

###  阶段二 PreCommit
在这个阶段中，协调者会根据参与者的反馈来决定是否最终可以进行事务的PreCommit操作。正常情况下，有二种可能
#### 执行事务预提交
1. 发送预提交请求:协调者向所有参与者节点发送PreCommit请求,进入Prepared 阶段
2. 事务预提交:参与者收到PreCommit请求后,会执行事务操作,并将 undo 和 redo 信息记录到事务日志中
3. 参与者向协调者反馈事务执行的响应:如果参与者成功执行了事务操作，就返回给协调者 ACK 响应，同时等待最终指令:提交(commit)或终止(abort)
#### 中断事务
假如任何一个参与者向协调者反馈了No 响应,或者在等待超时之后.协调者就会中断事务
1. 发送中断请求:协调者向所有的参与者发送 abort 指令
2. 中断事务:无论是收到来自协调者的 abort 请求,还是在等待协调请求过程中出现超时都会中断事务.
### 阶段三 doCommit
该阶段进行真正的事务提交,会存在以下二种可能

#### 执行提交
1. 进入到这一阶段,假设协调者出于正常工作状态,并且它接受到来来自所有参与者的ACK响应,那么它将从**预提交**状态转换到**提交状态**,并向所有的的参与者发送doCommit请求
2. 事务提交:参与者在接收到 doCommit 请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源
3. 反馈事务提交结果
4. 完成事务
#### 中断事务

只要有任何节点出现问题,事务都会被中断.
1. 发送中断请求
2. 事务回滚:参与者接收到 abort 请求后,会利用其在阶段二中记录的 undo 信息来执行事务回滚操作,并在完成提交之后释放在整个事务执行期间占用的事务资源
3. 反馈事务回滚结果
4. 中断事务

### 优缺点

- 优点:降低了参与者阻塞的范围,并且能够在出现单点故障后继续达成一致.
- 缺点:参与者在接受到PreCommit消息后,如果出现网络分区,此时协调者所在节点和参与者无法进行正常的网络通信,在这种情况下,该参与者依然会进行事务的提交,这必然会出现数据的不一致.                                                                