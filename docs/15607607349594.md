# 管理 Docker 中的数据

可以将数据存储到容器中的可写层，但是存在如下问题：
- 当该容器不再运行时，数据将不会持久保存，如果另一个进程需要数据，将很难从容器中取出数据。
- 容器的可写层与运行容器的主机紧密耦合。你不能轻易地将数据转移到其他地方。
- 写入容器的可写层需要存储驱动程序来管理文件系统。存储驱动程序使用Linux内核提供了一个联合文件系统。与使用直接写入主机文件系统的数据卷相比，这种额外的抽象降低了性能。

Docker提供三种不同的方式将数据从Docker主机装载到容器中: volumes, bind mounts, tmpfs。当有疑问时，volumes 几乎总是正确的选择。

## 选择正确的挂载类型

可视化volumes、bind mounts 和tmpfs装载之间差异的一个简单方法是考虑数据在Docker主机上的位置。
![](https://docs.docker.com/v17.09/engine/admin/volumes/images/types-of-mounts.png)

- Volumes：存储在由Docker管理的主机文件系统的一部分中(/var/lib/docker/volumes/ on Linux)。非docker 进程不应该修改文件系统的这一部分。volumes是将数据保存在文档中的最佳方式。
- Bind mounts：可以存储在主机系统的任何位置。它们甚至可能是重要的系统文件或目录。docker宿主机上的非 docker 镜像可以修改这些数据
- tmpfs mounts： 仅存储在主机系统的内存中，从不写入主机系统的文件系统。

### 关于挂载类型更多的信息

#### Volumes
由docker创建和管理。您可以使用docker volume create命令显式创建卷，或者docker可以在容器或服务创建期间创建卷。

创建卷时，它会存储在Docker主机的目录中。当您将卷装入容器时，该目录就是装入容器的内容。**除了卷由Docker管理并与主机的核心功能隔离之外**，这与绑定装载的工作方式类似。

给定的volume可以同时安装到多个容器中。当没有正在运行的容器正在使用卷时，该卷仍然可供docker使用，并且不会自动删除。您可以使用docker卷清理删除未使用的卷。

装载volume时，它可以是**命名**的或**匿名**的。匿名卷第一次装入容器时没有明确的名称，因此Docker会给它们一个随机名称，保证在给定Docker主机中是唯一的。除了名称之外，命名卷和匿名卷的行为方式相同。

卷还支持卷驱动程序的使用，它允许您在远程主机或云提供商上存储数据，以及其他可能性。

#### Bind mounts
与卷相比， Bind mounts 的功能有限。使用 Bind mounts时，主机上的文件或目录会装载到容器中。文件或目录被其主机上的完整路径引用。文件或目录不需要已经存在于Docker主机上。如果它还不存在，它是按需创建的。绑定挂载非常高效，**但是它们依赖于主机的文件系统**，该文件系统具有特定的可用目录结构。如果您正在开发新的Docker应用程序，请考虑改用named volumes 。您不能使用Docker命令行界面命令直接管理bind mounts。

> 无论好坏，使用绑定挂载的一个副作用是，您可以通过在容器中运行的进程来更改主机文件系统，包括创建、修改或删除重要的系统文件或目录。这是一种强大的能力，可能会带来安全隐患，包括影响主机系统上的非待办事项流程。


#### tmpfs mounts
tmpfs装载不会持久化在磁盘上，无论是在Docker主机上还是在容器内。在容器的生命周期中，它可以被容器用来存储非持久状态或敏感信息。例如，在内部，swarm服务使用tmpfs挂载将秘密信息挂载到服务的容器中。

##  volumes 的良好用例
卷是将数据保存在docker和服务中的首选方式。卷的一些用例包括:
- 在多个运行的容器之间共享数据。如果您没有显式创建它，卷将在首次装入容器时创建。当该容器停止或被移除时，该卷仍然存在。多个容器可以读写或只读方式同时装载同一个卷。只有在显式删除卷时，卷才会被删除。
- **当Docker主机不能保证具有给定的目录或文件结构时**。卷帮助您将Docker主机的配置与容器运行时分离。
- 当您想要将容器的数据存储在**远程主机或云提供**商而不是本地时。
- 当您需要能够将数据从一台Docker主机备份、恢复或迁移到另一台Docker主机时，卷是更好的选择。您可以停止使用卷的容器，然后备份卷的目录(例如/var/lib/docker/volumes/)。

当容器运行的宿主机不支持某种特定的文件系统时，可以配置 volume，将存储和运行分离开来。
##  bind mounts 的使用场景
- 将配置文件从主机共享到容器。默认情况下，Docker就是这样通过从主机安装/etc/resolv.conf到每个容器中来为容器提供域名解析的。
- 在Docker主机上的开发环境和容器之间共享源代码或构建工件。例如，您可以将Maven target/目录装载到容器中，并且每次在Docker主机上构建Maven项目时，容器都可以访问重建的工件。
- 当Docker主机的文件或目录结构保证与绑定装载一致时，可以使用

## tmpfs 使用场景

tmpfs装载最适合不希望数据保存在主机或容器中的情况。这可能是出于安全原因，或者是为了在应用程序需要写入大量非持久状态数据时保护容器的性能。

## bind mount 和 volumes 的区别
- 如果将empty volume装载到存在文件或目录的容器中的目录中，这些文件或目录将被传播(复制)到卷中。同样，如果您启动一个容器并指定一个尚不存在的卷，则会为您创建一个空卷。这是预先填充另一个容器需要的数据的好方法。
- 如果您将bind mount or non-empty volume 装载到容器中存在某些文件或目录的目录中，这些文件或目录会被装载遮挡，就像您将文件保存到Linux主机上的/mnt中，然后将u盘装载到/mnt中一样。在卸载u盘之前，/mnt的内容会被u盘的内容遮挡。隐藏的文件不会被删除或更改，但在绑定装载或卷装载时不可访问。

