# etcd高可用配置中心(有需要在深入了解)
实现服务发现，服务发布与订阅模块的关键技术：高可用的配置中心。etcd是一个服务发现配置存储中心。

## etcd应用场景
etcd是一个键值存储仓库，用于配置共享和服务发现。具有以下特点：

- 简单：基于HTTP+ JSON的API，用curl命令就可以使用
- 安全：可选SSL客户认证
- 快速：每个实例每秒支持一千次写操作。
- 可信：使用Raft算法实现分布式。

### 服务发现
服务发现：在同一个分布式集群中的进程或服务，互相感知并建立联系，这就是服务发现。本质上说，服务发现就是想要了解集群中是否有进程在监听UDP或TCP端口，并且通过对应的字符串名字信息就可以进行查找和连接。

要解决服务发现的问题，需要有下面三大支柱:

- 一个强一致性，高可用性的服务存储目录：基于raft算法的etcd就是这样一个存储目录
- 一种注册服务和监控服务健康状态的机制：在etcd中注册服务，并对注册的服务设置key TTL，定时保持服务的心跳来达到监控的目的
- 一种查找和连接服务的机制：在etcd指定的主题下注册的服务也能在对应的主题下被查找到。为了确保连接，每个服务机器上都部署一个proxy模式的etcd，这样就可以确保能访问etcd集群的服务都能互相连接。

![](https://ws4.sinaimg.cn/large/006tNbRwly1fx1j4jmns0j30m40e675y.jpg)

服务发现对应的具体场景：

 福田区高中学位补贴申报确认表 学校	深圳市福田区福景外国语	申报人	吴超雍 开户人	吴超雍	开户银行	中国建设银行 银行卡号	4367427200072426307	学生身份证号	441381200003074413 家长/监护人	吴德明	联系人手机号码	13537698585 申报时间	2017-04-13 15:18:50 签字	 年级	 日期	年月日 打印. 微服务协同工作架构中，服务动态添加。 
![](https://ws2.sinaimg.cn/large/006tNbRwly1fx1jay0obgj30ui0eywh4.jpg)
2. PaaS平台中应用多实例与实例故障重启透明化：PaaS平台中的应用一般都有多个实例，通过域名可以透明地对多个实例进行访问，而且还是先负载均衡。但是其中的某个实例随时都可能出现故障，这时就需要动态的配置域名解析中的信息。etcd的服务发现就可以轻松解决这个动态配置问题。
![](https://ws3.sinaimg.cn/large/006tNbRwly1fx1jb1beowj30uu0jmq5j.jpg)

### 消息发布与订阅
在分布式系统中，最适合组件间通信的方式是消息发布与订阅机制。具体来说，就是构建一个配置共享中心，数据提供者在这个配置中兴发布消息，而消息使用者则订阅他们关心的整体，一旦相关主题有消息发布，就会实时通知订阅者。通过这种方式实现分布式系统配置的集中式管理与实时动态更新。

### 负载均衡
在分布式系统中，为了保证服务的高可用性以及数据的一致性，会部署多分数据和服务，来达到对等服务。

### 分布式通知与协调

- 通过etcd进行低耦合的心跳检测
- 通过etcd完成系统调度
- 通过etcd完成汇报工作


### 分布式锁与竞选

etcd使用raft算法保持数据的强一至。某次操作存储到集群中的值必然是全局一致的，因此很容器实现分布式锁。锁服务有二种，一是保持独占，二是控制时序。

- 保持独占：即所有试图获得锁的用户最终只有一个可以得到。
- 控制时序：所有试图获得锁的用户都会进入等待队列，获得锁的顺序是全局唯一的，同时决定了队列的执行顺序。

### 分布式队列

### 集群监控
- 通过Watcher机制，当某个节点消失或则变动时，watcher会第一时间发现并告知用户。
- 节点设置TTL key，使用心跳机制来监控节点。


### etcd vs zookeeper
对比二者之间的差别，zookeeper更加复杂适合。etcd年轻有着简单易用的特点。


## etcd实现原理

### etcd架构
整体架构图如下
![架构图](https://ws4.sinaimg.cn/large/006tNbRwly1fx 福田区高中学位补贴申报确认表 学校	深圳市福田区福景外国语	申报人	吴超雍 开户人	吴超雍	开户银行	中国建设银行 银行卡号	4367427200072426307	学生身份证号	441381200003074413 家长/监护人	吴德明	联系人手机号码	13537698585 申报时间	2017-04-13 15:18:50 签字	 年级	 日期	年月日 打印ju0y7roj30n00gugof.jpg)

- HTTP Server：用于处理用户发送的API请求以及其他etcd节点的同步与心跳信息请求。
- Store：用于处理etcd支持的各类功能事务，包括数据索引，节点状态变更，监控和反馈，事件处理与执行。
- Raft：etcd的核心，算法的具体实现
- WAL：write ahead log 预写式日志，它是etcd的数据存储方式，除了在内存中存有所有数据的状态以及节点的索引外，etcd还通过WAL进行持久化存储，在WAL中所有的数据在提交前都会事先记录在日志中。

术语表
![](https://ws4.sinaimg.cn/large/006tNbRwly1fx1k1tonkij313w0mm46v.jpg)






















