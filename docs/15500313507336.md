#  分布式系统

## 分布式系统概览

分布式系统架构的难点在于系统设计，以及管理和运维，所有分布式系统解决了单点和性能容量的问题，但却新增了一堆问题。但却新增了一堆问题。而对于这些新增的问题，还会衍生出更多的子题，，这就需要我们不断地用各式各样的技术和手段来解决这些问题。

## 分布式系统的发展

从20世纪70年代的模块化编程，80年代的面向事件设计，90年代的基于接口/构件设计，这个世界很自然的演化出来SOA-基于服务的架构。SOA 架构是构造分布式计算应用程序的方法。它将应用程序功能作为服务发送给最终用户，或则其他服务。

面向服务架构有下面三个阶段：

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/DLWOS8czlD3sEZ9yzYj68y5jkY1hkwnQs7MmaxqqQ5g!/b/dDUBAAAAAAAA&bo=YQN3AQAAAAADBzY!&rf=viewer_4)

- 20 世纪 90 年代前，是单体架构，软件模块高度耦合。这是的SOA和普通的单体架构没有太大区别，当你调用一个服务时，这个服务会调用其他服务不停的调用。
- 而 2000 年左右出现了比较松耦合的 SOA 架构，这个架构需要一个标准的协议或是中间件来联动其它相关联的服务（ESB）,服务间不直接依赖，而是通过中间件的标准或则通讯框架相互依赖。这其实就是IOC（控制反转）和DIP（依赖倒置原则）的设计思想在架构中的实践。
- 2010后出现了微服务架构，这个架构更为松耦合。每一个微服务都能独立完整地运行（所谓的自自包含），后端单体的数据库也被微服务这样的架构分散到不同的服务中。它与传统的SOA差别在于，服务间的整合需要一个服务编排或是服务整合的引擎。就和交响乐中的指挥类似。

## 从亚马逊的实践，谈分布式系统的难点

可以从亚马逊多年的实践中学到的：

- 分布式服务的架构需要分布式的团队架构
- 分布式服务查错不容易
- 没有专职的测试人员，也没有专职的运维人员，开发人员做所有的事情。
- 运维优先，崇尚简化和自动化
- 内部服务和外部服务一致

## 分布式系统中需要注意的问题

1.异构系统的不标准问题

软件和应用不标准;通讯协议不标准; 数据格式不标准;开发和运维的过程和方法不标准

2.系统架构中的服务依赖性问题

在传统的单体服务中，一台机器挂了，整个软件就挂掉了。分布式架构下，服务是会有依赖的，于是一个服务依赖链上，某个服挂掉了，会导致出现“多米诺骨牌”效应，会倒一片。 如果非关键业务被关键业务所依赖，会导致非关键业务变成一个关键业务。服务依赖链中，出现“木桶短板效应” - 整个SLA由最差的那个服务所决定。

3.故障发生的概率更大

在分布式系统中，因为使用的机器和服务会非常多，所以，故障发生的频率会比传统的单体应用更大。对分布式系统架构的运维，简直就是一场噩梦。出现故障不可怕，故障恢复时间过长才可怕。出现故障不可怕，故障影响面过大才可怕。

4.多层架构的运维复杂度更大 通常来说，我们可以把系统分为四层：基础层，平台层，应用层和接入层。 任何一层的问题都会导致整体的问题.没有统一的视图和管理，导致运维被割裂开来，造成更大的复杂度。

## 分布式系统的技术栈

构建分布式系统的目的就是增加系统容量，提高可用性，转化为技术方面就是完成下面二件事：

- 大流量处理：通过集群技术把大规模并发请求发送的负载分散到不同的机器上
- 关键业务保护：提高后台服务的可用性，把故障隔离起来阻止多米诺骨牌效应。

一是提高整体架构的吞吐量，服务更多的并发和流量，二是为了提高提高系统的稳定性，让系统的可用性更高。

## 提高架构的性能

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/.vp2XL5Upfivhag6big5iOdZ0APV11K51V54fDS2nEc!/b/dFQBAAAAAAAA&bo=sAUoAgAAAAADN40!&rf=viewer_4)

常用技术

- 数据分区和数据镜像：数据分区是把数据按照一定的方式分成多个区（地理位置），不同的数据区来分担不同区的流量。这需要一个数据路由中间件，会导致跨库的Join和跨库的事务非常复杂。 数据镜像是把一个数据库镜像分成多份一样的数据，这样就不需要数据路由的中间件了。你可以在任意节点上进行读写，内部会自动同步数据。然而数据镜像中最大的问题就是数据一致性问题。

对于一般公司来说，在初期，会使用读写分离的数据镜像方式，而后会采用分库分表的方式。

## 提高架构的稳定性

![](http://a3.qpic.cn/psb?/V13l4Ff91EPvb0/iIrTI4sx5TEUHJ1.jZj9J.kGIyIKdllIEJXqCe38T8c!/b/dFIBAAAAAAAA&ek=1&kp=1&pt=0&bo=3gUqAgAAAAADN.E!&tl=1&vuin=947584280&tm=1540018800&sce=60-2-2&rf=viewer_4)

- 高可用维护：指的是DevOps中的CI/CD。一个良好的运维应该是一条很流畅的软件发布管线，其中做了足够的的自动化测试，还可以做相应的灰度发布，以及对线上系统的自动化控制。这样，可以做到“计划内”或是“非计划内”的宕机事件的时长最短。

## 分布式系统的关键技术

- 服务治理
- 架构软件管理
- DevOps
- 自动化运维
- 资源调度管理
- 整体架构监控
- 流量控制

想要实现上面这些所有的技术，需要投入大量的人力物力，这是分布式系统最大的门槛，但是这是一个很好的时代，通过Docker以及Kubernetes这一解决方案，大大地降低了做上面很多事情的门槛。我们可以利用docker的特性把软件在不同的机器上进行部署。docker这样容器化的虚拟技术是未来。

## 分布式系统的关键

- 全栈系统监控
- 服务/资源调度
- 流量调度
- 状态/数据调度
- 开发和运维的自动化

只有前面四项都做到了，第五项才能实现，所以前四项才是构建分布式系统的关键。

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/FRmfn0b7l0ZKfpZMT3YG917r5fQ9SWBcWYCRIS7q0yA!/b/dFMBAAAAAAAA&bo=FgYeAgAAAAADNx4!&rf=viewer_4)

## 分布式系统关键技术： 全栈监控

通过全栈监控，这就相当于我们的眼睛，没有它我们就不知道系统到底发生了什么。 这个监控系统需要完成的功能如下：

- 全栈监控
- 关联分析
- 跨系统调用的串联
- 实时报警和自动处理
- 系统性能分析

## 全栈监控

所谓全栈监控，就是三层监控 - 基础层：监控主机和底层资源，比如说CPU，内存，网络吞吐，硬盘I/O，硬盘使用等 - 中间层：对中间层的监控，比如说：Nginx,Redis,ActiveMQ,Kakfa,MySQL,Tomactd等。 - 应用层：监控应用层的使用，比如说HTTP访问的吞吐量，相应时间，调用链路分析。

整体的架构如下：

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/LdNck6MHxQRZLnC67RuDwPlFTWeOT*BDNSRWluiGzVM!/b/dFMBAAAAAAAA&bo=.gVMAgAAAAADB5M!&rf=viewer_4)

还需要一些监控的标准化：

- 日志数据结构化
- 监控数据格式标准化
- 统一的监控平台
- 统一的日志分析

## 一个好的监控系统

- 关注于整体的应用的SLA：主要从为用户服务的API来监控整个系统
- 关联指标聚合
- 快速故障定位

一个好的监控系统主要为以下二个场景设计的

- 容量管理
- 性能管理
- 定位问题
- 性能分析

## 如何做出一个好的监控系统

- 服务调用链跟踪：这个监控系统应该从对外的 API 开始，然后将后台的实际服务给关联起来，再将这个服务的依赖服务给关联起来，直到最后一个服务（如 MySQL 或 Redis），这样就可以把整个系统的服务全部都串连起来了。这个事情的最佳实践是 Google Dapper 系统，其对应于开源的实现是 Zipkin。对于 Java 类的服务，我们可以使用字节码技术进行字节码注入，做到代码无侵入式。
- 服务调用时长分布
- 服务的TOP N视图：所谓的TOP N 视图就是一个系统请求的排名情况。
- 数据库操作关联
- 资源服务跟踪：我们的服务可能运行在物理机上，也可能运行在虚拟机里，还可能运行在一个 Docker 的容器里，Docker 容器又运行在物理机或是虚拟机上。我们需要把服务运行的机器节点上的数据（如CPU、MEM、I/O、DISK、NETWORK）关联起来。

有了一个完整高效的监控系统之后，当系统出现任何问题的时候，就可以快速的定位到问题所在，并且针对特定的问题找到对应设计的解决方案。来完成自动化调度。

## 分布式系统关键技术：服务调度

涉及到服务治理的关键技术有如下几点：

- 服务关键程度
- 服务依赖关系
- 服务发现
- 整个架构的版本管理
- 服务应用生命周期全管理。

## 服务关键程度和服务依赖关系

微服务是服务依赖最优解的上限，服务依赖的下限是千万不要有依赖环。系统架构中有依赖环说明你的架构是错误的，依赖环有很多副作用，最大的问题就是一种极强的耦合，会导致服务部署相当的复杂和难解，而且会导致无穷尽的递归故障和意想不到的情况。

解决服务依赖环的方案一般是，依赖倒置的设计模式。在分布式架构上，你可以使用一个第三方的服务来解决这个事。比如，通过订阅或发布消息到一个消息中间件，或是把其中的依赖关系抽到一个第三方的服务来调用这些原本循环依赖的服务。

在梳理完服务的重要程度和服务依赖关系之后，我们就相当于知道了整个架构的全局。这就相当于一个城市的地图，在这张地图上你可以看到城市的关键设施，主干道，通过监控系统就可以很清楚的了解到整个城市的工作情况。

## 服务状态和生命周期的管理

有了上面的一张地图后，我们还需要有一个服务发现的中间件，这个中间件是非常非常关键的。因为这个“架构城市”是非常动态的，有的服务会新加进来，有的会离开，有的会增加更多的实例，有的会减少，有的服务在维护过程（发布、伸缩等），所以我们需要有一个服务注册中心，来知道这些事：

- 整个架构中有多少种服务
- 这些服务的版本是什么样额
- 每个服务的实例数有多少，他们的状态是什么样的
- 每个服务的状态是什么

## 整个架构的版本管理

在分布式架构中，我们也需要一个架构的版本，用来控制其中各个服务的版本兼容。比如，A 服务的 1.2 版本只能和 B 服务的 2.2 版本一起工作，A 服务的上个版本 1.1 只能和B 服务的 2.0 一起工作。这就是版本兼容性。

如果架构中有这样的问题，那么我们就需要一个上层架构的版本管理。这样，如果我们要回滚一个服务的版本，就可以把与之有版本依赖的服务也一起回滚掉。

要做到这单，需要一个架构的manifest，一个服务清单，这个服务清单定义了所有服务的版本运行环境

## 资源/服务调度

- 服务状态的维持和拟合：服务运行时的状态是非常关键的，服务运行过程中状态总是变化的，有这二种变化：
    - 不预期的变化
    - 预期的变化

详细说明一下，对于分布式系统的服务管理来说，当需要把一个状态变成另一个状态时，我们需要对集群进行一系列的操作。这个操作的过程一定是比较“慢”的。一方面，需要对其它操作排它；另一方面，在整个过程中，我们的控制系统需要努力地逼近最终状，直到完全达到。此外，正在运行的服务可能也会出现问题，离开了我们想要的状态，而控制系统检测到后，会强行地维持服务的状态。

我们把这个过程就叫做“拟合”。基本上来说，集群控制系统都是要干这个事的，具体可以参考K8S是如何做的。

- 服务的弹性伸缩和故障迁移
- 服务工作流和编排

## 分布式系统关键技术：流量与数据调度

## 流量调度的主要功能

主要功能是：

1. 依据系统的运行情况，自动地进行流量调度，在无需人工干预的情况下，提升整个系统的稳定性
2. 让系统应对突发事件时，在弹性计算扩容的较长时间窗口内或底层资源消耗殆尽的情况下，让系统平稳运行。

这些都应该是一个API Gateway应该做的事。

## 流量调度的关键技术

一个好的Gateway要调度流量首先要抗住流量，而且还需要有一些比较轻量级的业务逻辑，所以一个好的Gateway需要具备以下技术：

- 高性能
- 抗流量：需要使用集群技术，集群技术的关键在于集群内各个节点中共享数据，这需要你使用像Paxos，Raft，Gossip这样的通讯协议。
- 业务逻辑
- 服务化

## 分布式事务一致性问题

数据节点在scale时，会涉及到数据 replication问题。数据的replication会带来数据一致性问题，进而对性能带来很大的影响。

要解决数据不丢失，只能通过数据冗余的方法，数据副本的方法，当某个节点数据丢失时，可以从副本中读到。在解决数据副本间的一致性问题时，我们有一些技术方案：

- Master-Slave
- Master-Master
- 二阶段和三阶段提交方案
- paxos方案

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/uOk*Uz7xt*BhuAcPi9J2HeYjoCtngPuAHiVn6WYPIws!/b/dFQBAAAAAAAA&bo=BAbAAgAAAAADR6I!&rf=viewer_4)

实际上，在应用层上解决事务问题，只有“二阶段提交”这样的方式，而在数据层解决事务问题，Paxos算法是不二之选。

## 数据节点的分布式方案

真正完整解决数据scale问题的应该还是数据节点自身。只有数据节点自身解决了这个问题，才能对上层业务的透明，业务层可以向操作单机一样来操作分布式的数据库，这样才能租到整个分布式服务架构的调度。这个就涉及到不同种类数据的处理了，这也是为什么会有这么多不同类型的数据库。

## 状态数据调度小结

- 对于应用层上的分布式事务一致性，只有二阶段提交这样的方式
- 底层存储可以解决这个问题的方式是通过Paxos，Raft和NER这样的算法和模型来解决
- 状态数据调度应该由分布式存储系统来解决。

## PaaS平台的本质

一个好的PaaS平台应该具有分布式，服务化，自动化部署，高可用，敏捷以及分层开放的特征，并可与LaaS实现良好的联动。

PaaS与传统的中间最大差别是一下三件事：

- 服务化是PaaS的本质。软件模块重用，服务治理，对外提供能力是PaaS的本质
- 分布式是PaaS的根本特性，多租户隔离，高可用，服务编排
- 自动化是PaaS的灵魂，自动化部署安装运维，自动化伸缩调度是PaaS的关键

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/UF3X2Dm2QZcKsVJDK2BQd9V51weUcg0f8XRxV6lFK2s!/b/dDQBAAAAAAAA&bo=2ANKAwAAAAADJ5A!&rf=viewer_4)

一个完整的PaaS平台会包括一下几个部分：

- PaaS调度层:PaaS自动化和分布式对于高可用高性能的管理
- PaaS能力服务层：PaaS真正提供给用户的服务和能力
- PaaS的流量调控：主要是与流量调度相关的东西，包括对高并发的管理
- PaaS运营管理：软件资源库，软件接入，认证和开发平台门户
- PaaS运维管理：DevOps相关的东西

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/jJks1*10JXD9r1.oCbaJlZTgKajKAq2UsBW3X*BvZ74!/b/dDYBAAAAAAAA&bo=zgXMAwAAAAADR2Y!&rf=viewer_4)

## PaaS平台的生产和运维

下面这张图给出了一个大概的软件生产，运维和服务接入的图。

![](http://a4.qpic.cn/psb?/V13l4Ff91EPvb0/Ny51XCZEq0lZ7vitXb03hZjsOfHcWuDnMTN6XwcT6Zk!/b/dDMBAAAAAAAA&ek=1&kp=1&pt=0&bo=0AU4AgAAAAADN*0!&tl=1&vuin=947584280&tm=1540022400&sce=60-4-3&rf=viewer_4)

从左上开始软件构建，进入软件资产库（Docker Registry+ 一些软件的定义），然后走 DevOps 的流程，通过整体架构控制器进入生产环境，生产环境通过控制器操作 Docker+Kubernetes 集群进行软件部署和生产变更。

其中，同步服务的运行状态，通过生命周期管理来拟合状态，图图右侧部分所示，服务运行时的 数据会进入到相关应用监控，应用监控中的一些监控事件会同步到生命周期管理中，在由生命周期管理器来做出决定，通过架构控制器来调度服务运行。当应用监控中心发现流量变化，要进行强制性伸缩是，它通过生命周期管理来通知控制系统进行伸缩。

## 总结

![](http://m.qpic.cn/psb?/V13l4Ff91EPvb0/Va1pqtarX5GSjeq6rVBb4Q24amgy9JUBdVEKLSY9eoc!/b/dFMBAAAAAAAA&bo=OARhBQAAAAADB3o!&rf=viewer_4)