# 镜像扫描任务

跟踪从`docker client`登录，镜像上传，启动镜像扫描任务的执行流程。结合日志信息整理出` harbor `的处理逻辑。

## 1. docker client

登录的执行流程可以参考官方的文档，其中详细的解释了登录和上传镜像的流程。

假设将镜像仓库部署在地址为192.168.1.100的主机上，用户可以通过docker命令去访问这个镜像仓库。

当用户输入了要求的登录信息之后，docker client会向192.1681.1.100发送一个HTTP GET request。安全镜像仓库的各个容器组件将会依次处理这个请求。
![](http://www.think-foundry.com/wp-content/uploads/2016/09/article1_image3.png)

- a.这个请求被监听80端口的容器所接受，容器中的Nginx将这个请求转发给后端的Registry容器
- b.Registry容器已经配置了基于token 服务的身份验证，因此会返回错误代码401，通知Docker Client从指定的URL获取有效的token。 
- c.当Docker客户端收到401错误代码时，它会向令牌服务URL发送请求，在请求头中嵌入用户名和密码
- d.在通过端口80将该请求发送到代理容器之后，Nginx根据预先配置的规则将请求转发到UI容器，UI容器内的token服务接受请求，解码请求并获得用户名和密码。
- e.获得用户名和密码之后，token服务检查数据库并通过MySql数据库中的数据对对用户进行身份验证。身份验证成功之后，token服务将返回成功的HTTP代码。HTTP相应中包含了由私钥生成的token。

下面根据日志信息追踪一下登录的流程。在命令行输入一下登录信息后，后端的` nginx`服务器会将请求转发给`Registry`
```
 chenxu@chenxudeMacBook-Pro ： docker  login 172.16.21.135                                                                                                                           
Username: admin
Password:
Login Succeeded
```

**a.**下面是来时` nginx`的日志信息，第一行就是将请求转发给` registry`后，返回的状态码为` 401`
```
May 21 00:00:17 172.20.0.1 proxy[1037]: 172.16.21.1 - "GET /v2/ HTTP/1.1" 401 87 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.008 0.008 .
May 21 00:00:17 172.20.0.1 proxy[1037]: 172.16.21.1 - "GET /service/token?account=admin&client_id=docker&offline_token=true&service=harbor-registry HTTP/1.1" 200 892 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.024 0.024 .
May 21 00:00:17 172.20.0.1 proxy[1037]: 172.16.21.1 - "GET /v2/ HTTP/1.1" 200 2 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.006 0.004 .

```

**b.**在` registry`的日志中，可以看待来自`172.20.0.1`请求错误的原因是未授权，返回` 401`错误。

```
May 21 00:00:17 172.20.0.1 registry[1037]: time="2019-05-21T07:00:17.625023689Z" level=warning msg="error authorizing context: authorization token required" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=d8e60fb9-2f52-4a0a-a97b-7ccf8f805a5a http.request.method=GET http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 00:00:17 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:07:00:17 +0000] "GET /v2/ HTTP/1.1" 401 87 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 00:00:17 172.20.0.1 registry[1037]: time="2019-05-21T07:00:17.658476538Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=ce9c7da9-90a7-4217-beb9-3f1663f066d0 http.request.method=GET http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.contenttype="application/json; charset=utf-8" http.response.duration=1.303394ms http.response.status=200 http.response.written=2 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 00:00:17 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:07:00:17 +0000] "GET /v2/ HTTP/1.1" 200 2 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"

```


**c.**`nginx`将对`/service/token`请求转发给` core`
```
May 21 00:00:17 172.20.0.1 proxy[1037]: 172.16.21.1 - "GET /service/token?account=admin&client_id=docker&offline_token=true&service=harbor-registry HTTP/1.1" 200 892 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.024 0.024 .
```

**d.**在` core`中的日志信息，接受到了来自` docker client `访问`/service/token`API的请求，获取到`token`数据。
```
May 21 00:00:17 172.20.0.1 core[1037]: 2019/05/21 07:00:17 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[43m 401 #033[0m|   6.365828ms|   match|#033[44m GET     #033[0m /v2/   r:/v2/*#033[0m
May 21 00:00:17 172.20.0.1 core[1037]: 2019/05/21 07:00:17 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 200 #033[0m|  23.553983ms|   match|#033[44m GET     #033[0m /service/token   r:/service/token#033[0m
May 21 00:00:17 172.20.0.1 core[1037]: 2019/05/21 07:00:17 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 200 #033[0m|    4.22712ms|   match|#033[44m GET     #033[0m /v2/   r:/v2/*#033[0m

```

最后在` registry`日志中可以看到用户登录成功

```
May 21 00:00:17 172.20.0.1 registry[1037]: time="2019-05-21T07:00:17.658476538Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=ce9c7da9-90a7-4217-beb9-3f1663f066d0 http.request.method=GET http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.contenttype="application/json; charset=utf-8" http.response.duration=1.303394ms http.response.status=200 http.response.written=2 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 00:00:17 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:07:00:17 +0000] "GET /v2/ HTTP/1.1" 200 2 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"

```

### 1.1 上传镜像
所有发往` registry`的请求都会被` core`中的` /v2/*`路由所处理，给其增加授权信息，在访问内部` registry`时都需要对请求进行修改。

在上传镜像时，上传请求首先被` nginx`重定向到` core`的` /v2/*`路由中去。
```
May 21 01:14:27 172.20.0.1 proxy[1037]: 172.16.21.1 - "GET /v2/ HTTP/1.1" 401 87 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.005 0.004 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "GET /service/token?account=admin&scope=repository:hpc/hello-world:push%2Cpull&service=harbor-registry HTTP/1.1" 200 966 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.028 0.032 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "HEAD /v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced HTTP/1.1" 404 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.006 0.008 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "POST /v2/hpc/hello-world/blobs/uploads/ HTTP/1.1" 202 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.013 0.016 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "PATCH /v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23?_state=nxr34EhDkfKucAse3teAo3hngkYQdSQHKiTn542XJuh7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiY2NhMzVkMmUtMDJjOC00MWRmLTgwZjgtOTM4MTkwMWYzYTIzIiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4LjAzNTM3NDAwM1oifQ== HTTP/1.1" 202 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.025 0.024 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "PUT /v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23?_state=yeQOuz49rU_bD4S4pHpF2kQuWfL--sBwRZvJ4XKNuD57Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiY2NhMzVkMmUtMDJjOC00MWRmLTgwZjgtOTM4MTkwMWYzYTIzIiwiT2Zmc2V0Ijo5NzcsIlN0YXJ0ZWRBdCI6IjIwMTktMDUtMjFUMDg6MTQ6MjhaIn0=&digest=sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced HTTP/1.1" 201 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.018 0.016 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "HEAD /v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced HTTP/1.1" 200 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.010 0.008 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "HEAD /v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e HTTP/1.1" 404 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.006 0.004 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "POST /v2/hpc/hello-world/blobs/uploads/ HTTP/1.1" 202 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.014 0.012 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "PATCH /v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e?_state=Q9NwcipUt44VqAiJy7GW5mxMTgts2T_nbcTZvHaSgxl7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiMWEyNmRmM2UtNzRhNy00ODkxLTk1NjItODE3N2YzNTRjZDNlIiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4LjEyODA3OTMxOVoifQ== HTTP/1.1" 202 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.026 0.024 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "PUT /v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e?_state=48sCokThnGE9LVFmw7fa0_0GpiUs1BXdISVZBW_iiUh7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiMWEyNmRmM2UtNzRhNy00ODkxLTk1NjItODE3N2YzNTRjZDNlIiwiT2Zmc2V0IjoxNTEwLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4WiJ9&digest=sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e HTTP/1.1" 201 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.016 0.016 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "HEAD /v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e HTTP/1.1" 200 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.009 0.008 .
May 21 01:14:28 172.20.0.1 proxy[1037]: 172.16.21.1 - "PUT /v2/hpc/hello-world/manifests/v1 HTTP/1.1" 201 0 "-" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \x5C(darwin\x5C))" 0.053 0.052 .

```

在` core.log`中可以查看到请求的记录，`core`组件除了对发往` registry`的请求做了处理外还**提供了通知服务**。通知服务根据要求会对请求进行过滤，只要符合要求的几种才能进行接下来的处理。首先会将访问信息存储到数据库表`AccessLog`中
- 对于` push`操作的请求
    - 会检查数据库中是否创建对应的镜像`repository`，如果没有创建会在此时进行创建
    - 等待镜像上传完成，调用的是`coreutils.WaitForManifestReady`方法。
    - 完成镜像上传之后，发出通知。像这样`[INFO] Handle notification with topic 'OnPush': notification.OnPushNotification{Image:"hpc/hello-world:v1"}`
    - 检测是否开启了上传镜像自动扫描功能
- 对于` pull`操作
    - 将数据库中`pull count`数字加 1



```
May 21 01:14:27 172.20.0.1 core[1037]: 2019/05/21 08:14:27 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[43m 401 #033[0m|   4.727316ms|   match|#033[44m GET     #033[0m /v2/   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 200 #033[0m|  27.584339ms|   match|#033[44m GET     #033[0m /service/token   r:/service/token#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[43m 404 #033[0m|   4.689515ms|   match|#033[45m HEAD    #033[0m /v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 202 #033[0m|  12.521805ms|   match|#033[46m POST    #033[0m /v2/hpc/hello-world/blobs/uploads/   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 202 #033[0m|  23.042553ms|   match|#033[42m PATCH   #033[0m /v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 201 #033[0m|  16.541766ms|   match|#033[43m PUT     #033[0m /v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |     172.20.0.4|#033[42m 200 #033[0m|    685.317µs|   match|#033[46m POST    #033[0m /service/notifications   r:/service/notifications#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 200 #033[0m|   9.208685ms|   match|#033[45m HEAD    #033[0m /v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |     172.20.0.4|#033[42m 200 #033[0m|   1.144007ms|   match|#033[46m POST    #033[0m /service/notifications   r:/service/notifications#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[43m 404 #033[0m|   4.626824ms|   match|#033[45m HEAD    #033[0m /v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 202 #033[0m|  12.705295ms|   match|#033[46m POST    #033[0m /v2/hpc/hello-world/blobs/uploads/   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 202 #033[0m|  23.532071ms|   match|#033[42m PATCH   #033[0m /v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 201 #033[0m|   15.21146ms|   match|#033[43m PUT     #033[0m /v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |     172.20.0.4|#033[42m 200 #033[0m|    349.374µs|   match|#033[46m POST    #033[0m /service/notifications   r:/service/notifications#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 200 #033[0m|   7.886165ms|   match|#033[45m HEAD    #033[0m /v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |     172.20.0.4|#033[42m 200 #033[0m|    357.071µs|   match|#033[46m POST    #033[0m /service/notifications   r:/service/notifications#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |    172.16.21.1|#033[42m 201 #033[0m|  51.682542ms|   match|#033[43m PUT     #033[0m /v2/hpc/hello-world/manifests/v1   r:/v2/*#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |     172.20.0.4|#033[42m 200 #033[0m|  42.840283ms|   match|#033[46m POST    #033[0m /service/notifications   r:/service/notifications#033[0m
May 21 01:14:28 172.20.0.1 core[1037]: 2019-05-21T08:14:28Z [INFO] Handle notification with topic 'OnPush': notification.OnPushNotification{Image:"hpc/hello-world:v1"}
May 21 01:14:28 172.20.0.1 core[1037]: 2019/05/21 08:14:28 #033[1;44m[D] [server.go:2619] |     172.20.0.4|#033[42m 200 #033[0m|    577.633µs|   match|#033[46m POST    #033[0m /service/notifications   r:/service/notifications#033[0m

```
`registry`每完成一部分操作时，就会调用` core`中的`/service/notifications`路由，当完成了镜像上传任务时，`core`日志中会有以信息出现 

```
May 21 01:14:28 172.20.0.1 core[1037]: 2019-05-21T08:14:28Z [INFO] Handle notification with topic 'OnPush': notification.OnPushNotification{Image:"hpc/hello-world:v1"}
```



在` registry`的日志中，可以看到镜像上传的全部过程

```
May 21 01:14:27 172.20.0.1 registry[1037]: time="2019-05-21T08:14:27.987079563Z" level=warning msg="error authorizing context: authorization token required" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=2ec90010-cf79-491f-bbae-98cd5ec42634 http.request.method=GET http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:27 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:27 +0000] "GET /v2/ HTTP/1.1" 401 87 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.028725061Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=1.066581ms service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.029282978Z" level=error msg="response completed with error" auth.user.name=admin err.code="blob unknown" err.detail=sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced err.message="blob unknown to registry" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=27ae12dc-d5e4-4475-9b35-73459d715691 http.request.method=HEAD http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.contenttype="application/json; charset=utf-8" http.response.duration=2.872044ms http.response.status=404 http.response.written=157 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry vars.digest="sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced" vars.name="hpc/hello-world" version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "HEAD /v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced HTTP/1.1" 404 157 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.045703982Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=e9a629c5-4474-4b52-824d-9e9d4638db0f http.request.method=POST http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/uploads/" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.duration=11.62696ms http.response.status=202 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "POST /v2/hpc/hello-world/blobs/uploads/ HTTP/1.1" 202 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.07484601Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=6d0a9471-8538-4fd9-b785-0f8ffa856862 http.request.method=PATCH http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23?_state=nxr34EhDkfKucAse3teAo3hngkYQdSQHKiTn542XJuh7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiY2NhMzVkMmUtMDJjOC00MWRmLTgwZjgtOTM4MTkwMWYzYTIzIiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4LjAzNTM3NDAwM1oifQ==" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.duration=22.057173ms http.response.status=202 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "PATCH /v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23?_state=nxr34EhDkfKucAse3teAo3hngkYQdSQHKiTn542XJuh7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiY2NhMzVkMmUtMDJjOC00MWRmLTgwZjgtOTM4MTkwMWYzYTIzIiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4LjAzNTM3NDAwM1oifQ== HTTP/1.1" 202 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.094235305Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=885.053µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.095434831Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=b82a8437-abd8-4a85-b997-acc993b60109 http.request.method=PUT http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23?_state=yeQOuz49rU_bD4S4pHpF2kQuWfL--sBwRZvJ4XKNuD57Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiY2NhMzVkMmUtMDJjOC00MWRmLTgwZjgtOTM4MTkwMWYzYTIzIiwiT2Zmc2V0Ijo5NzcsIlN0YXJ0ZWRBdCI6IjIwMTktMDUtMjFUMDg6MTQ6MjhaIn0=&digest=sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.duration=15.480252ms http.response.status=201 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "PUT /v2/hpc/hello-world/blobs/uploads/cca35d2e-02c8-41df-80f8-9381901f3a23?_state=yeQOuz49rU_bD4S4pHpF2kQuWfL--sBwRZvJ4XKNuD57Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiY2NhMzVkMmUtMDJjOC00MWRmLTgwZjgtOTM4MTkwMWYzYTIzIiwiT2Zmc2V0Ijo5NzcsIlN0YXJ0ZWRBdCI6IjIwMTktMDUtMjFUMDg6MTQ6MjhaIn0=&digest=sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced HTTP/1.1" 201 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.102334584Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=911.197µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.10397861Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=934.6µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.105910442Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=1.198557ms service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.107169408Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=859.425µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.108216304Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=2fa34182-6fca-4fff-a958-f74bc8104c9d http.request.method=HEAD http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.contenttype="application/octet-stream" http.response.duration=7.848576ms http.response.status=200 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "HEAD /v2/hpc/hello-world/blobs/sha256:1b930d010525941c1d56ec53b97bd057a67ae1865eebf042686d2a2d18271ced HTTP/1.1" 200 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.121574971Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=819.823µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.122160313Z" level=error msg="response completed with error" auth.user.name=admin err.code="blob unknown" err.detail=sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e err.message="blob unknown to registry" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=cb71b0fe-7c6d-488d-9a84-3c7e59f2755a http.request.method=HEAD http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.contenttype="application/json; charset=utf-8" http.response.duration=3.623884ms http.response.status=404 http.response.written=157 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry vars.digest="sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e" vars.name="hpc/hello-world" version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "HEAD /v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e HTTP/1.1" 404 157 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.138829722Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=58bd48fb-e8f7-4e09-b901-67e3575f4b8d http.request.method=POST http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/uploads/" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.duration=11.851103ms http.response.status=202 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "POST /v2/hpc/hello-world/blobs/uploads/ HTTP/1.1" 202 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.165873413Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=31327845-0187-4721-a4da-34c8e28bd3e5 http.request.method=PATCH http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e?_state=Q9NwcipUt44VqAiJy7GW5mxMTgts2T_nbcTZvHaSgxl7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiMWEyNmRmM2UtNzRhNy00ODkxLTk1NjItODE3N2YzNTRjZDNlIiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4LjEyODA3OTMxOVoifQ==" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.duration=21.857891ms http.response.status=202 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "PATCH /v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e?_state=Q9NwcipUt44VqAiJy7GW5mxMTgts2T_nbcTZvHaSgxl7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiMWEyNmRmM2UtNzRhNy00ODkxLTk1NjItODE3N2YzNTRjZDNlIiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4LjEyODA3OTMxOVoifQ== HTTP/1.1" 202 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.184740179Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=739.054µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.185342617Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=67df3855-13ab-4173-8949-6ab1d2c67fcc http.request.method=PUT http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e?_state=48sCokThnGE9LVFmw7fa0_0GpiUs1BXdISVZBW_iiUh7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiMWEyNmRmM2UtNzRhNy00ODkxLTk1NjItODE3N2YzNTRjZDNlIiwiT2Zmc2V0IjoxNTEwLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4WiJ9&digest=sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.duration=13.8845ms http.response.status=201 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "PUT /v2/hpc/hello-world/blobs/uploads/1a26df3e-74a7-4891-9562-8177f354cd3e?_state=48sCokThnGE9LVFmw7fa0_0GpiUs1BXdISVZBW_iiUh7Ik5hbWUiOiJocGMvaGVsbG8td29ybGQiLCJVVUlEIjoiMWEyNmRmM2UtNzRhNy00ODkxLTk1NjItODE3N2YzNTRjZDNlIiwiT2Zmc2V0IjoxNTEwLCJTdGFydGVkQXQiOiIyMDE5LTA1LTIxVDA4OjE0OjI4WiJ9&digest=sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e HTTP/1.1" 201 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.192629969Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=657.583µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.194098142Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=762.056µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.195212298Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=799.763µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.197144099Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=1.142646ms service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.197843077Z" level=info msg="response completed" go.version=go1.7.3 http.request.host=172.16.21.135 http.request.id=bfd96d32-2b57-440f-b835-eac3e0388a80 http.request.method=HEAD http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.contenttype="application/octet-stream" http.response.duration=6.974602ms http.response.status=200 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "HEAD /v2/hpc/hello-world/blobs/sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e HTTP/1.1" 200 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.207070367Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=2.44728ms service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.208177937Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=580.915µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.209637474Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=787.463µs service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.253559406Z" level=info msg="response completed" go.version=go1.7.3 http.request.contenttype="application/vnd.docker.distribution.manifest.v2+json" http.request.host=172.16.21.135 http.request.id=37b68b79-ab84-4b32-83d4-5974ca530715 http.request.method=PUT http.request.remoteaddr=172.16.21.1 http.request.uri="/v2/hpc/hello-world/manifests/v1" http.request.useragent="docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))" http.response.duration=50.362111ms http.response.status=201 http.response.written=0 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "PUT /v2/hpc/hello-world/manifests/v1 HTTP/1.1" 201 0 "" "docker/18.09.2 go/go1.10.6 git-commit/6247962 kernel/4.9.125-linuxkit os/linux arch/amd64 UpstreamClient(Docker-Client/18.09.2 \\(darwin\\))"
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.258416762Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=1.839553ms service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.261849597Z" level=info msg="redis: connect redis:6379" go.version=go1.7.3 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 redis.connect.duration=2.630127ms service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: time="2019-05-21T08:14:28.263794343Z" level=info msg="response completed" go.version=go1.7.3 http.request.host="registry:5000" http.request.id=1d68ffe2-3620-4869-a964-d915204e56e5 http.request.method=HEAD http.request.remoteaddr="172.20.0.8:35054" http.request.uri="/v2/hpc/hello-world/manifests/v1" http.request.useragent=harbor-registry-client http.response.contenttype="application/vnd.docker.distribution.manifest.v2+json" http.response.duration=8.948312ms http.response.status=200 http.response.written=524 instance.id=d2ef7576-b297-466c-8e7e-3e0fc4af9981 service=registry version=v2.6.2 
May 21 01:14:28 172.20.0.1 registry[1037]: 172.20.0.8 - - [21/May/2019:08:14:28 +0000] "HEAD /v2/hpc/hello-world/manifests/v1 HTTP/1.1" 200 524 "" "harbor-registry-client"

```

镜像中一层的上传分为 4 个部分
- HEAD：`HEAD /v2/<name>/blobs/<digest>`检查指定的`layer`是否存在
- POST：`POST /v2/<name>/blobs/uploads/` `name`是镜像的命名空间，`layer`将链接到该命名空间下。`post`请求成功后，会返回 202 同时返回的还有一个上传`URL`
- PATCH：`PATCH /v2/<name>/blobs/uploads/<uuid>`上传指定`uuid`的 `layer`
- PUT：`PUT /v2/<name>/blob/uploads/<uuid>?digest=<digest>`要使上传被视为完成，需要发送带有摘要（digest）参数的`PUT`请求。

**通过上述 4 个步骤，就可以成功的将一个 layer 上传到`registry`中，同时`layer`的信息也写入到了` redis`中。当完成了所有层的上传后，`docker client`会发送`HEAD /v2/<name>/manifests/<reference>`判断镜像有没有上传完整。如果没有问题，镜像上传成功**


## 2. 启动指定仓库的镜像扫描任务

在此目录中`portl/lib/src/tag/tag.component.html`，通过下面的函数来发布镜像扫描任务

```go
// Trigger scan
  scanNow(t: Tag[]): void {
    if (t && t.length) {
      t.forEach((data: any) => {
        let tagId = data.name;
        this.channel.publishScanEvent(this.repoName + "/" + tagId);
      });
    }
  }
```

在`lib/src/vulnerability-scanning/result-bar-chart.component.ts`文件夹`onInit()`方法中，订阅了上述扫描镜像的事件。

```go
ngOnInit(): void {
        // 这个地方
        this.scanSubscription = this.channel.scanCommand$.subscribe((tagId: string) => {
            let myFullTag: string = this.repoName + "/" + this.tagId;
            if (myFullTag === tagId) {
                this.scanNow();
            }
        });
    }
```

当初始化函数在`scanCommand$`通道中接收到了。

**目前有一个问题，修改 `lib`中的代码重新编译，无法起作用。可能和编译的方式有关系,需要使用` npm run build_lib`即可解决这个问题。**


在`scanNow()`中调用了`scanningService`的`startVulnerabilityScanning`方法来向后端服务器发送镜像扫描任务，参数为` repoName: string,    tagId: string`。具体实现如下：

```go
startVulnerabilityScanning(
    repoName: string,
    tagId: string
  ): Observable<any> | Promise<any> | any {
    if (!repoName || repoName.trim() === "" || !tagId || tagId.trim() === "") {
      return Promise.reject("Bad argument");
    }
    return this.http
      .post(
        `${this._baseUrl}/${repoName}/tags/${tagId}/scan`,
        HTTP_JSON_OPTIONS
      )
      .toPromise()
      .then(() => {
        return true;
      })
      .catch(error => Promise.reject(error));
  }
```

访问的 API 为`/api/repositories/${repoName}/tags/${tagId}/scan`。

## 3. 后端对应的服务
在后端服务器中，有4个处理镜像扫描任务的 API，罗列如下：
1. `	beego.Router("/api/repositories/scanAll", &api.RepositoryAPI{}, "post:ScanAll")`
2. `	beego.Router("/api/repositories/*/tags/:tag/scan", &api.RepositoryAPI{}, "post:ScanImage")`
3. `	beego.Router("/api/jobs/scan/:id([0-9]+)/log", &api.ScanJobAPI{}, "get:GetLog")`
4. `	beego.Router("/service/notifications/jobs/scan/:id([0-9]+)", &jobs.Handler{}, "post:HandleScan")`

第一个是用来启动所有镜像的扫描任务，第二个是扫描指定镜像，第三个获取镜像扫描的结果，第四个用来内部组件之间完成镜像扫描任务的通知机制。

接下来主要分析 2，3，4 API 的具体实现。

### 3.1 镜像扫描任务

---
#### 3.1.1 任务的注册
在 `jobservice`的启动过程中，会先对` harbor`可执行的任务进行注册。在`src/jobservice/pool/redis_pool.go#267`中，给每种类型的 `job` 创建执行函数。提前在 `redis` 中注册好。当`redis` 中有新 `job` 时，只需调用对应处理函数即可。

```go
gcwp.pool.JobWithOptions(name,
		work.JobOptions{MaxFails: theJ.MaxFails()},
		func(job *work.Job) error {
			// 执行 job 的逻辑重点
			return redisJob.Run(job)
		}, // Use generic handler to handle as we do not accept context with this way. 
	)
```
上述代码中的` name`是 `job`的标识，回调函数就是此种类型` job`的执行逻辑。这些数据都被存储在了`jobTypes: map[string]*jobType`结构体中。在 `src/jobservice/pool/redis_pool.go#216`处，`worker pool`中会不断的获取` redis`中的任务，获取到了任务之后，就是根据` job name`从` jobTypes`结构体中获取其之前注册的执行函数。在`src/vendor/github.com/gocraft/work/worker.go#206`处，开始执行此次任务。

---

#### 3.1.2 core 组件 发送`/api/repositories/*/tags/:tag/scan`
在`src/core/api/repository.go`中的`ScanImage()`中完成了对请求中参数的提取以及验证功能。主要的触发任务时调用`src/core/utils/job.go`中的`TriggerImageScan(repository string, tag string)`函数。`TriggerImageScan(repository string, tag string)`函数是对`triggerImageScan(repository, tag, digest string, client job.Client)`函数的包装。

**1.**在`TriggerImageScan（）`中为` core`组件创建了访问` repository`的内部客户端。同时使用镜像的` tag`参数来检测` registry`是否存在此镜像同时获得其`digest`。

这项检查完成之后，就调用其私有方法`triggerImageScan()`。首先更新数据库中表`img_scan_job`数据，将此次扫描任务的基本信息存入到数据库中。

```go
id, err := dao.AddScanJob(models.ScanJob{
		Repository: repository,
		Digest:     digest,
		Tag:        tag,
		Status:     models.JobPending,
	})
```

**2.**上述操作没问题之后，更新数据库中表`img_scan_overview`的数据，插入的数据如下：

```go
rec := &models.ImgScanOverview{
		Digest:     digest,
		JobID:      jobID,
		UpdateTime: time.Now(),
	}
```
**3.**构建一个扫描任务所需要的数据，调用的`buildScanJobData()`方法。其具体实现如下：

```go
func buildScanJobData(jobID int64, repository, tag, digest string) (*jobmodels.JobData, error) {
	parms := job.ScanJobParms{
		JobID:      jobID,
		Repository: repository,
		Digest:     digest,
		Tag:        tag,
	}
	parmsMap := make(map[string]interface{})
	b, err := json.Marshal(parms)
	if err != nil {
		return nil, err
	}
	err = json.Unmarshal(b, &parmsMap)
	if err != nil {
		return nil, err
	}
	meta := jobmodels.JobMetadata{
		JobKind:  job.JobKindGeneric,
		IsUnique: false,
	}

	data := &jobmodels.JobData{
		Name:       job.ImageScanJob,
		Parameters: jobmodels.Parameters(parmsMap),
		Metadata:   &meta,
		StatusHook: fmt.Sprintf("%s/service/notifications/jobs/scan/%d", config.InternalCoreURL(), jobID),
	}

	return data, nil
}

```
扫描任务的参数，`job`的种类名称以及设置好`StatusHook`，等扫描任务完成后用来通知` core`组件。一个完成的` job`数据定义如下：

```go
type JobData struct {
	Name       string       `json:"name"`
	Parameters Parameters   `json:"parameters"`
	Metadata   *JobMetadata `json:"metadata"`
	StatusHook string       `json:"status_hook"`
}
```

**4.**构造完成镜像扫描任务` data`之后，调用` jobservice`的 `client`的`SubmitJob(*models.JobData)`方法将任务提交到` jobservice`中。这个` jobDate`中的数据会被` jobservice`写入到` redis`数据库中。

`SubmitJob()`的实现比较简单，发送` POST`请求访问` jobservice`的API`d.endpoint + "/api/v1/jobs"`来提交任务。 

`jobservice`接受到任务之后，进行一些列处理后，执行镜像扫描任务。

---
#### 3.1.3 jobservice 组件处理`/api/v1/jobs`请求

通过层层接口的抽象包装，给实现解耦合起到多态的作用。


此 API 调用了` jobservice`的`HandleLaunchJobReq()`来处理发送的` jobData`数据。在执行完一些验证操作后，调用` jobservice`中` core`文件夹定义的整个后端工作池控制器接口的`LaunchJob()`方法。

`LaunchJob()`是连接请求和` jobservice`工作池的一个连接点，主要完成一下几件工作。
- 首先验证发送来的` jobData`中工作的类型是否是后端支持的三种类型之一`(Generic,Periodic,Scheduled)`。
- 然后检测` job`的名字`(IMAGE_GC,IMAGE_DELETE,IMAGE_SCAN,IMAGE_SCAN_ALL,IMAGE_REPLICATE,	IMAGE_TRANSFER)`是否在工作池中注册。
- 验证` jobData`中的参数是否和` job`的类型相匹配
- 根据 `job` 的类型将` job`安排到不同的任务调度器中。因为镜像扫描任务的类型为`Generic`，这里使用的是默认类型。

 后端工作池的调度器如下
 ```
c.backendPool.Enqueue(req.Job.Name, req.Job.Parameters, req.Job.Metadata.IsUnique)
```
然后在其中调用了`*work.Enqueuer`的`Enqueue()`方法，将任务信息存储到` redis`中。**目前预计 harbor 使用了框架的功能，此工作框架会执行队列中的任务**然后构造好` job`的状态信息并将其运行状态设置为` pending`，具体包含的数据如下：

```go
return models.JobStats{
		Stats: &models.JobStatData{
			JobID:       j.ID,
			JobName:     j.Name,
			JobKind:     jobKind,
			IsUnique:    isUnique,
			Status:      job.JobStatusPending,
			EnqueueTime: j.EnqueuedAt,
			UpdateTime:  time.Now().Unix(),
			// 对应着数据库中 img_scan_job 表中的数据
			RefLink:     fmt.Sprintf("/api/v1/jobs/%s", j.ID),
		},
```
上述数据中，`jobID` 信息保存在`postgresql`数据库的` img_scan_job`表中，其可以对应到一个具体的镜像。`jobName`就是`IMAGE_SCAN`，`RefLink`连接到具体的 `core` 中`job`。



**接下来的这一步十分重要：实现任务真正的提交，具体实现就是调用`JobStatsManager`的` Save`方法，将`JobStats`数据保存到`JobStatsManager`的消息处理通道上`processChan`**。到目前为止完成了` jobstats`数据的处理，成功的存储到`redis`中。


在` core`组件将` jobData`发送给` jobservice`的`/api/repositories/*/tags/:tag/scan`API 之后，`jobservice`中完成了对事件的接受。日志信息如下所示，
```go
May 27 02:38:12 172.18.0.1 jobservice[1071]: 2019-05-27T09:38:12Z [INFO] Receive event 'register_hook' with data(unformatted): map[string]interface {}{"job_id":"44778059e2954ebb48bc9144", "hook_url":"http://core:8080/service/notifications/jobs/scan/75"}
```

`job_id`和` hook_url`的消息服务器获取之后存储在了`HookStore`中。




,`hook_url`定义了` jobservice`和` core`组件之间通信的桥梁。接下来` jobservice`会发送方法为`POST`的请求访问core 的`/service/notifications/jobs/scan/75`API来更新完成镜像扫描之后数据库中表` img_scan_job`的信息。


---
#### 3.1.4 core 组件 `/service/notifications/jobs/scan/:id` 

用来更新数据库中`img_scan_job`表的信息。



### 3.2 外部框架

`jobservice`将任务放入到框架的队列之后，在`src/jobservice/pool/redis_pool.go#216`中，启动的` worker`不停的监听` redis`中数据的变化，获取其中的` job`并执行。



### 3.3 任务执行
任务的执行分为二个部分：
1. 构建需要执行的函数主要有三个：
    1. opCommandFunc
    2. checkInFunc
    3. launchJobFunc：启动任务的函数
2. 调用具体任务类型的启动方法，来运行执行任务`src/jobservice/pool/redis_job_wrapper.go#135`

接下来分析一下镜像扫描任务的实现逻辑。
- 获取日志收集器
- 初始化` job`，获取` registry`的` url`；`tokenService`的服务地址；`JOBSERVICE_SECRET`的参数；`Clair`的` url`
- 解析` job`的参数，主要是` jobID`,`Repository`,`Tag`,`Digest`。
- 创建访问指定` repository`的` repoClient`
- 使用刚刚创建的`repoClient`使用` tag`参数来获取此镜像的` manifest`。此文件中含有了这个镜像的所有概要信息，里面有多少` layer`以及每一` layer`的`digest`是多少。
- 创建访问`Repository`的`token`信息，传入的参数有需要方法存储库的名称，密码以及`token`服务器的地址
- p`repareLayers(payload, cj.registryURL, jobParms.Repository, token)`使用镜像的 `manifest`，需要访问的镜像的`registry`，存储镜像的`Repository`以及`token` 信息。通过这些信息准备好需要扫描的`layer`
- 创建访问` clair`的客户端，遍历镜像的所有层，使用` clair`客户端启动每一层的扫描任务。通过层的名字获取扫描结果。
- 最后将结果存储到数据库中

完成上述任务后，设置` job`的状态。调用同步通信机制，将最新的状态信息发送给` core`组件，根据数据库中` job`的状态信息。