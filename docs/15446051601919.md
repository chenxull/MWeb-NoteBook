# harbor 深入学习

## harbor VS Docker Registry

Harbor在Docker Registry基础之上，提供了用户，同步等诸多特性。我现在要做的工作就是熟悉HPC环境中的工作流程，思考可以在Harbor的那些方面进行改进，来使得改进后的harbor更好的服务于HPC环境


## Harbor的镜像同步
### 为什么需要镜像同步
由于对镜像的访问是一个核心的容器概念，在实际使用过程中，一个镜像库可能是不够用的，下例情况下，我们可能会需要部署多个镜像仓库：

- 国外的公有镜像下载过慢，需要一个中转仓库进行加速
- 容器规模较大，一个镜像仓库不堪重负
- 对系统稳定性要求高，需要多个仓库保证高可用性
- 镜像仓库有多级规划，下级仓库依赖上级仓库

在企业级软件环境中，会在软件开发的不同阶段存在不同的镜像库

- 在开发环境库，开发人员频繁修改镜像，一旦代码完成，生成稳定的镜像即需要同步到测试环境。
- 在测试环境库，测试人员对镜像是只读操作，测试完成后，将镜像同步到预上线环境库。
- 在预上线环境库，运维人员对镜像也是只读操作，一旦运行正常，即将镜像同步到生产环境库。
- 在这个流程中，各环境的镜像库之间都需要镜像的同步和复制。

### 镜像的同步机制
有了多个镜像仓库，在多个仓库之间进行镜像同步马上就成为了一个普遍的需求。比较传统的镜像同步方式，有两种：

- 第一种方案，使用Linux提供的RSYNC服务来定义两个仓库之间的镜像数据同步。
- 第二种方案，对于使用IaaS服务进行镜像存储的场景，利用IaaS的配置工具来对镜像的同步进行配置。

这两种方案都依赖于仓库所在的存储环境，而需要采用不同的工具策略。Harbor则提供了更加灵活的方案来处理镜像的同步，其核心是三个概念：

- 用Harbor自己的API来进行镜像下载和传输，作到与底层存储环境解耦。
- 利用任务调度和监控机制进行复制任务的管理，保障复制任务的健壮性。在同步过程中，如果源镜像已删除，Harbor会自动同步删除远端的镜像。在镜像同步复制的过程中，Harbor会监控整个复制过程，遇到网络等错误，会自动重试。
- 提供复制策略机制保证项目级的复制需求。在Harbor中，可以在项目中创建复制策略，来实现对镜像的同步。与Docker Registry的不同之处在于，Harbor的复制是推（PUSH）的策略，由源端发起，而Docker Registry的复制是拉（PULL）的策略，由目标端发起。


### 多级部署
在实际的企业级生产运维场景，往往需要跨地域，跨层级进行镜像的同步复制，比如集团企业从总部到省公司，由省公司再市公司的场景。
这一部署场景可简化如下图：

![](https://www.kubernetes.org.cn/img/2017/03/20170314213455.jpg)

更复杂的部署场景如下图：

![](https://www.kubernetes.org.cn/img/2017/03/20170314213503.jpg)

