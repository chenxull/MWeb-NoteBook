# statefulSet

## 为什么需要 statefulSet
在使用 replicaSet 资源时，如果 pod 模板中描述一个关联到特定持久卷 声明的数据卷，那么 replicaSet 所有的副本都将共享这个持久卷声明，也就是绑定到同一个持久卷声明。

这就无法实现每一个副本都指定独立的持久卷声明。 一个解决方案是一个 pod 实例对应着一个 replicaset，这种方法比较笨重，如果想要扩容必须创建新的replicaset。


出了上述的存储需求，一些集群应用会要求每个实例拥有生命周期内唯一的表示。**这在分布式环境中分普遍，这类应用需要管理员在每个集群成员的配置文件中列出所有其他集群成员的 IP 地址。**但是在 kubernetes 中，重新调度一次 pod，这个新 pod 就会有新的主机名和 IP 地址。很不友好。


## StatefulSet

使用 statefulSet 创建的 pod，这类应用中**每个实例都是一个不可替代的实体，都拥有稳定的名称和状态。**

![](http://ww4.sinaimg.cn/large/006tNc79ly1g65y25psacj30u40l03zm.jpg)

StatefulSet 的拓扑结构和其他用于部署的资源其实比较类似，比较大的区别在于 StatefulSet 引入了 PV 和 PVC 对象来持久存储服务产生的状态，这样所有的服务虽然可以被杀掉或者重启，但是其中的数据由于 PV 的原因不会丢失。
### 对于 statefulSet 与 replicaSet

宠物与牛的类比。对于无状态的应用，行为就像农场里的牛一样，一个实例挂掉后没有什么影响。  对于宠物类的应用，替换掉它需要拥有和旧的案例完全一致的状态和标识。

使用 statefulSet 重新创建的 pod，必须与被替换的实例拥有相同的名称，网络表示和状态。同时 pod 之间并不是完全一样的，每个 pod 都可以拥有独立的数据卷。

### 控制服务网络
 statefulSet  通常要求你创建一个用来记录每个 pod 网络标记的 headless servic。通过这个 Service，每个 pod 都将拥有独立的 DNS 记录，这样集群中其他的伙伴可以通过主机名方便的找到它。
 
 总的来说 statefulSet 资源确保了 pod 拥有稳定的标记和独立的存储。在 pod 模板汇总，拥有多个 pvc 模板，

### at-most-one
要确保二个拥有相同表示和绑定相同持久卷声明的有状态 pod 不会同时运行，