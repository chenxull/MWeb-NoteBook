# defer
**defer语句通常用于一些成对操作的场景：打开连接/关闭连接；加锁/释放锁；打开文件/关闭文件等。**


## 原理

每次defer语句执行的时候，会把函数压 stack，函数参数会被拷贝下来；当外层函数退出时，defer 函数按照定义的逆序执行；如果 defer 函数执行的函数是 nil，那么会在最总调用函数时产生 panic。

defer 不会马上执行，会进入 stack，按先进后出的顺序执行。

在defer函数定义时，对外部变量的引用是有两种方式的，分别是作为**函数参数**和作为**闭包引用**。作为函数参数，**则在defer定义时就把值传递给defer，并被cache起来；**

**作为闭包引用的话，则会在defer函数真正调用时根据整个上下文确定当前的值。**


## recover
panic会停掉当前正在执行的程序，不只是当前协程。**在这之前，它会有序地执行完当前协程defer列表里的语句**，其它协程里挂的defer语句不作保证。因此，我们经常在defer里挂一个recover语句，防止程序直接挂掉，这起到了try...catch的效果。