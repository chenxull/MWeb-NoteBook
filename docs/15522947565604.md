# Notary 服务架构

![](https://camo.githubusercontent.com/c4166122f8b4e908ad9d59421072ea1f64074a9d/68747470733a2f2f63646e2e7261776769742e636f6d2f7468657570646174656672616d65776f726b2f6e6f746172792f303966383137313730383066353332373665363838316563653537636262626639316238653261372f646f63732f696d616765732f6b65792d6869657261726368792e737667)

上述的图就是TUF架构中的各个角色信息分别为：
- root key
- 时间戳 key
- 快照key
- 目标 key
- 委托人key

## notary架构和构成组件
Notary客户端从一个或多个(远程)Notary服务中提取元数据。一些Notary客户将元数据推送到一个或多个Notary服务。

 Notary服务由一个Notary服务器和一个Notary签名者组成，前者为相关数据库中的多个可信集合存储和更新签名的TUF元数据文件，后者为Notary服务器存储私钥和签名元数据。下图说明了这种体系结构:
 ![](https://camo.githubusercontent.com/d6252fb5a1f727bf2e1b2a8779a38459ad8f9553/68747470733a2f2f63646e2e7261776769742e636f6d2f7468657570646174656672616d65776f726b2f6e6f746172792f303966383137313730383066353332373665363838316563653537636262626639316238653261372f646f63732f696d616765732f736572766963652d6172636869746563747572652e737667)
 
Root, targets, and (sometimes) snapshot metadata 由客户端生成并签名，客户端将元数据上传到Notary服务器。服务器负责: 
- 确保任何上传的元数据都是有效的、签名的和自我一致的 
- 生成时间戳(有时是快照)元数据 
- 存储并向客户端提供任何可信集合的最新有效元数据

Notary signer: 
- 将使用Javascript对象签名和加密包装和加密的私有签名密钥存储在独立于Notary 服务器数据库的数据库中 
- 每当Notary 服务器请求时，使用这些密钥执行签名操作

##客户端-服务器-签名者交互示例

![](https://camo.githubusercontent.com/ed2875a6c47d940f573d6f0af22432a4ac67858b/68747470733a2f2f63646e2e7261776769742e636f6d2f7468657570646174656672616d65776f726b2f6e6f746172792f323734363966303166653234346264663730663334323139363136363537623333363732346263332f646f63732f696d616765732f6d657461646174612d73657175656e63652e737667)

1. Notary 服务器可选地支持来自使用JWT令牌的客户端的认证。这需要一个管理访问控制的授权服务器，以及来自该授权服务器的证书包，该证书包包含用于签名令牌的公钥。 如果Notary服务器上启用了令牌身份验证，则任何没有令牌的连接客户端都将被重定向到授权服务器。 
2. 客户端将通过HTTPS上的基本授权登录到授权服务器，获取承载令牌，然后在将来的请求中将令牌呈现给公证服务器。
3. 当客户端上传新的元数据文件时，公证人服务器会检查它们与任何以前版本的冲突，并验证上传的元数据的签名、校验和和有效性。
4. 一旦所有上传的元数据被验证，公证人服务器生成时间戳(可能还有快照)元数据。它将生成的元数据发送给公证人签名人进行签名。
5. Notary签名者从其数据库中检索必要的加密私钥(如果有的话)，解密密钥，并使用它们对元数据进行签名。如果成功，它会将签名发送回公证人服务器。
6. Notary 服务器是可信数据集合状态的真实来源，在TUF数据库中存储客户端上传和服务器生成的元数据。生成的时间戳和快照元数据证明客户端上传的元数据文件是该可信集合的最新文件。 最后，Notary 服务器将通知客户端他们的上传成功。
7. 客户端现在可以立即从服务器下载最新的元数据，使用仍然有效的承载令牌进行连接。Notary 服务器只需要从数据库中获取元数据，因为没有元数据过期。 在时间戳过期的情况下，公证服务器将遍历整个序列，在其中生成新的时间戳，请求Notary 签名者签名，将新签名的时间戳存储在数据库中。然后，它将这个新时间戳以及存储的元数据的其余部分发送给请求客户端。