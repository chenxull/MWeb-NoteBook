# To Docker or Not to Docker: A Security Perspective

## 目前主要安全工作

主要集中在宿主机和容器之间的关系。但是容器现在是一个复杂系统的一部分，涉及到许多的容器各种各样的镜像仓库以及容器的编排，这些都是高度自动的。在这整条链路上，会涉及到需要第三方因素运行其中，而这些都是存在潜在的安全问题，会留下漏洞给攻击者可乘之机。



## docker 安全总览

docker安全主要依赖于三个方面的因素：

- Docker守护程序管理的用户空间级别进程的隔离
- 内核强制执行此隔离
- 网络操作安全性。

### 隔离

Namespace和capability通过默认的方式起作用，但是cgroups的限制需要通过手动的配置去限制容器的资源使用。docker的全局安全可以在启动docker容器事通过选项指令而降低。例如使用 ```insecure-registry``` 选项可以关闭TLS服务。

### 主机强化

主机通过Linux内核的安全机制可以增强容器的安全，目前SELinux, Apparmor, and Seccomp都在docker中默认支持

### 网络安全

docker通过hash检测在传输的过程中使用TLS来增加分发image的安全，同时现在还使用Docker Content Trust架构来时开发者在发布他们的image前进行image签名，确保image的内容不会恶意改动。DCT是基于the update framework(TUF)其是专门设计用来解决包管理器漏洞的。

### 为什么要使用TLS？

docker daemon通过套接字进行远程控制，从而可以从其他主机执行任何Docker命令。 默认情况下，用于控制守护程序的sock是一个Unix套接字，位于/var/run/docker.sock并由root:docker所拥有，但是Unix套接字可以被更改成TCP套接字，通过访问此套接字，攻击者可以在特权模式下提取和运行任何容器，从而为其提供对主机的root访问权限。 在Unix套接字的情况下，docker组的用户成员可以获得root权限; 当使用TCP套接字时，与此套接字的任何连接都可以为主机提供root权限。 因此，必须使用TLS（-tlsverify）保护连接，这样可以对连接的两端进行加密和身份验证（并且需要额外的证书管理）。



## docker Usages：安全挑战之处

去定义一个合理的docker 使用规范来讨论它们的安全隐患以及它们如何影响Docker的安全性非常重要。

### docker的用法

这里有三种不同的docker使用方法。

对于docker的开发者来说，正如docker官方文档推荐的那样，应该使用微服务模式。也就是说每一个容器必须在单进程或者在守护进程中托管单个服务。因此容器不应该被认为是一个虚拟机，没有包管理器，没有init进程，没有sshd来管理它。 必须通过主机执行所有管理任务（容器停止，重新启动，备份，更新，构建等），这意味着合法容器的管理员具有对主机的root访问权限。

Docker开发人员还建议对应用程序进行可重复的自动部署。 Docker镜像应该通过通用构建文件（Dockerfile）在任何地方构建，该文件指定从基本图像构建图像的步骤。 这种构建图像的通用方式使得过程和结果图像几乎与主机无关，仅取决于内核而不是安装的库。

一些开发者和系统管理员使用docker运行完整的虚拟环境并定期更新，虽然这很方便，因为其将系统管理任务降到了最低，但是这会存在潜在的安全隐患。 容器嵌入了足够的软件来运行一个完整的系统（日志守护程序，ssh服务器，甚至有时是一个init进程），从容器中执行管理任务很有诱惑力，但是这与Docker的设计完全相反。 实际上，其中一些管理任务需要对容器进行root访问，而其他管理操作（例如在容器中安装卷）可能需要Docker默认删除的额外功能。这样攻击者就可以很容易通过容器来攻击宿主机器。

平台即服务有PaaS所倡导用来处理安全和基础架构问题，亚马逊云计算服务和谷歌容器引擎是市场上的领导者，这两种解决方案都提供了类似的方法：创建VM或VM群集，使用Orchestrator工具管理VM内的容器。 在此模型中，容器的管理员拥有对Orchestrator的完全权利。 微服务方法由DevOps和Docker当前需要手动配置到整个部署工具链，从适当的节点上启动适当的图像。 该任务通过或者构建执行图像来自动化。 管理VM集群的管理员，它们自己在多个物理主机上运行。



### 可能的攻击方式

#### 直接攻击

直接攻击者可以通过嗅探，阻塞，注入，或者更改网络和系统通信的方式，他们的直接目标就是生产设备。来使得系统组件损坏：

- 生产中的容器：当容器运行着网络服务时，攻击者获取其中一个容器的root权限时，他可以发动拒绝服务（DOS）攻击来攻击同宿主机系统中其他的容器。
- 生产中的主机操作系统：攻击者获得其中一个容器的root权限之后，可以接触到主机操作系统的核心文件，发动容器逃离攻击。
- 生产中的docker守护进程:攻击者可能从受损的主机操作系统上启动容器时降低默认的安全启动参数。
- 生产网络：在受损的主机操作系统中，攻击者可能间接的使用网络流量攻击来破坏

#### 间接攻击

攻击者通过源代码或则镜像数据来到达生产环境中。根据攻击阶段，我们可以将其过程分为一下阶段：容器，主机操作系统，相关容器，代码仓库，镜像仓库，管理网络。

可能被攻击的过程——容器，代码仓库，镜像仓库因为这些公共都可以访问到并且有开放的接口。



技术上，docker已经支持了很多安全限制，但是在人为的操作之下，广泛的用法利用了启动时Docker守护程序或启动容器的命令的选项，这些选项为容器提供了对主机的扩展访问。 与不受信任的容器一起使用时，这些选项会引发许多安全问题，包括：

- 提供了从主机到容器的扩展访问
- 将主机敏感的数据挂载到容器中
- TLS配置没有开启
- Docker控制的套接字的访问权限以及Cgroup服务是否开启。



### 可能存在的安全漏洞

不安全的本地的配置；较弱的本地访问控制；镜像分发过程中的漏洞

#### 镜像分发过程中的漏洞

考虑在自动部署中，Docker Hub提出的自动构建和webhook是映像分发过程中的关键元素。它将产生一个管道，其中每个元素都可以完全访问将最终生成的代码，并且越来越多地托管在云中。例如，为了自动执行此部署，Docker建议在Docker Hub上实现自动构建，由来自外部代码存储（例如github）的事件触发。然后，Docker建议将HTTP请求发送到可在Internet上访问的Docker主机，以通知它可以使用新映像。这会触发图像拉动并在新图像上重新启动容器。在此部署管道中，github上的提交将触发新映像的构建并自动将其启动到生产中。可以在生产之前添加可选的测试步骤，这些步骤本身可以托管在另一个提供商处。在这种情况下，Docker Hub首先调用测试机器，然后使用回调URL拉取映像，运行测试并将结果发送到Docker Hub。构建过程本身通常会从其他第三方存储库下载依赖项，有时会在容易被篡改的不安全通道上下载。

此设置为代码路径添加了几个外部中间步骤，每个步骤都有自己的身份验证和攻击面，从而增加了全局攻击面。



这个漏洞其实很危险，假如攻击者成功的破坏了依赖代码库中的某些代码，并且植入后门，对手可能通过docker生态系统将后门docker容器投入生产。根据测试对手的代码在他们提交github后的五分半钟内投入生产。值得注意的是，这种攻击可以扩展到任意数量的机器。

尽管破坏代码存储库独立于Docker，但是即使在几分钟内删除了恶意代码，自动将其推送到生产环境中也会大大增加受感染计算机的数量。妥协也可能发生在Docker中心帐户级别，具有相同的后果。帐户劫持不是一个新问题，但它应该是对不同提供商的帐户倍增的日益关注。

这些漏洞在PaaS使用中尤为重要，其目的是在所有层面广泛使用自动化，以缩短开发周期并持续交付。但是这些漏洞的存在使得这些自动化的实现存在问题。

k8s可能对于大规模环境中的安全问题有着自己的解决方法，这个方面需要去了解一下。
